local a=(...):match("(.-)[^%.]+$")local b=require(a.."/lib/betterblittle")local c=require(a.."/lib/pinepack")local d=math.min;local e=math.max;local f=math.floor;local g=math.ceil;local function h(i,j,k,l)local m={width=k,height=l,colorValues={},depthValues={},blitWin=window.create(term.current(),i,j,k,l,false),backgroundColor=colors.lightBlue}function m:setSize(i,j,k,l)self.width=k;self.height=l;self.blitWin.reposition(i,j,k,l)self:clear()end;function m:clear()self.colorValues={}self.depthValues={}local colors=self.colorValues;local n=self.depthValues;local o=math.huge;local p=self.width;local q=self.backgroundColor;for j=1,self.height do colors[j]={}n[j]={}local r=colors[j]local s=n[j]for i=1,p do r[i]=q;s[i]=o end end end;function m:clearDepth()local n=self.depthValues;local o=-math.huge;local p=self.width;for j=1,self.height do local s=n[j]for i=1,p do s[i]=o end end end;function m:fastClear()local t=self.backgroundColor;local colors=self.colorValues;local p=self.width;for j=1,self.height do local r=colors[j]for i=1,p do r[i]=t end end end;function m:setPixel(i,j,u)i=f(i+0.5)j=f(j+0.5)if i>=1 and i<=self.width then if j>=1 and j<=self.height then self.colorValues[j][i]=u end end end;function m:image(i,j,v)local p=self.width;local colors=self.colorValues;for w,x in pairs(v)do local y=w+j;local r=colors[y]if r then for z,A in pairs(x)do if A and A>0 then local B=z+i;if B>=1 and B<=p then r[B]=A end end end end end end;function m:drawLineNoInterp(C,D,E,F,u,G)local colors=self.colorValues;local n=self.depthValues;local H=self.width;local I=self.height;local J=E-C;local K=F-D;if J~=0 then for i=e(g(d(C,E)),1),d(f(e(C,E)),H)do local L=(i-C)/J;local j=f(D+L*K+0.5)if j>0 and j<=I and G>=n[j][i]then colors[j][i]=u;n[j][i]=G end end end;if K~=0 then for j=e(g(d(D,F)),1),d(f(e(D,F)),I)do local M=(j-D)/K;local i=f(C+M*J+0.5)if i>0 and i<=H and G>=n[j][i]then colors[j][i]=u;n[j][i]=G end end end end;function m:drawLineInterp(C,D,E,F,u,N,O)local colors=self.colorValues;local n=self.depthValues;local H=self.width;local I=self.height;C=C+0.5;E=E+0.5;D=D-0.5;F=F-0.5;local J=E-C;local K=F-D;local P=O-N;if J~=0 then for i=e(g(d(C,E)),1),d(f(e(C,E)),H)do local L=(i-C)/J;local j=f(D+L*K+0.5)local Q=N+L*P;if j>0 and j<=I and Q>=n[j][i]then colors[j][i]=u;n[j][i]=Q end end end;if K~=0 then for j=e(g(d(D,F)),1),d(f(e(D,F)),I)do local M=(j-D)/K;local i=f(C+M*J+0.5)local Q=N+M*P;if i>0 and i<=H and Q>=n[j][i]then colors[j][i]=u;n[j][i]=Q end end end end;local R=colors.black;function m:drawTriangleNoInterp(C,D,E,F,S,T,u,U,V)if C<0 and E<0 and S<0 or D<1 and F<1 and T<1 then return end;local H=self.width;if C>H and E>H and S>H then return end;local I=self.height;if D>I and F>I and T>I then return end;if D>F then D,F=F,D;C,E=E,C end;if F>T then T,F=F,T;S,E=E,S end;if D>F then D,F=F,D;C,E=E,C end;local f,g=f,g;local d,e=d,e;local W=d(e(1,g(D)),I)local X=d(e(0,f(F)),I)local Y=d(e(1,f(T)),I)local colors=self.colorValues;local n=self.depthValues;local G=1/V;if D~=F and D~=T then local Z=(E-C)/(F-D)local _=(S-C)/(T-D)for j=W,X do local K=j-D;local a0=C+K*Z;local a1=C+K*_;if a1<a0 then a0,a1=a1,a0 end;local a2=f(a0+0.5)local a3=f(a1+0.5)if a2<1 then a2=1 end;if a3>H then a3=H end;local r=colors[j]local s=n[j]for i=a2,a3 do if G>s[i]then s[i]=G;r[i]=u end end end end;if T~=F and D~=T then local Z=(E-S)/(F-T)local _=(C-S)/(D-T)for j=X+1,Y do local K=j-T;local a0=S+K*Z;local a1=S+K*_;if a1<a0 then a0,a1=a1,a0 end;local a2=f(a0+0.5)local a3=f(a1+0.5)if a2<1 then a2=1 end;if a3>H then a3=H end;local r=colors[j]local s=n[j]for i=a2,a3 do if G>s[i]then s[i]=G;r[i]=u end end end end;local U=U;if U or self.triangleEdges then local a4=self.drawLineNoInterp;local u=U or R;a4(self,C,D,E,F,u,G)a4(self,E,F,S,T,u,G)a4(self,S,T,C,D,u,G)end end;function m:drawTriangleInterp(C,D,E,F,S,T,u,U,a5,a6,a7,a8)if C<0 and E<0 and S<0 or D<1 and F<1 and T<1 then return end;local H=self.width;if C>H and E>H and S>H then return end;local I=self.height;if D>I and F>I and T>I then return end;if D>F then D,F=F,D;C,E=E,C;a6,a7=a7,a6 end;if F>T then T,F=F,T;S,E=E,S;a8,a7=a7,a8 end;if D>F then D,F=F,D;C,E=E,C;a6,a7=a7,a6 end;local f,g=f,g;local d,e=d,e;local W=d(e(1,g(D)),I)local X=d(e(0,f(F)),I)local Y=d(e(1,f(T)),I)local colors=self.colorValues;local n=self.depthValues;local a9=1/a8;local O=1/a7;local N=1/a6;if D~=F and D~=T then local aa=F-D;local ab=T-D;local Z=(E-C)/aa;local _=(S-C)/ab;local ac=O-N;local ad=a9-N;for j=W,X do local K=j-D;local a0=C+K*Z;local a1=C+K*_;local ae=K/aa;local af=K/ab;local ag=N+ae*ac;local ah=N+af*ad;if a1<a0 then a0,a1=a1,a0;ag,ah=ah,ag end;local a2=f(a0+1.5)local a3=f(a1+0.5)if a2<1 then a2=1 end;if a3>H then a3=H end;a0=f(a0+0.5)a1=f(a1+1.5)local ai=a1-a0;local r=colors[j]local s=n[j]local aj=ah-ag;for i=a2,a3 do local L=(i-a0)/ai;local Q=ag+L*aj;if Q>s[i]then s[i]=Q;r[i]=u end end end end;if T~=F and D~=T then local ak=F-T;local al=D-T;local Z=(E-S)/ak;local _=(C-S)/al;local ac=O-a9;local ad=N-a9;for j=X+1,Y do local K=j-T;local a0=S+K*Z;local a1=S+K*_;local ae=K/ak;local af=K/al;local ag=a9+ae*ac;local ah=a9+af*ad;if a1<a0 then a0,a1=a1,a0;ag,ah=ah,ag end;local a2=f(a0+1.5)local a3=f(a1+0.5)if a2<1 then a2=1 end;if a3>H then a3=H end;a0=f(a0+0.5)a1=f(a1+1.5)local ai=a1-a0;local r=colors[j]local s=n[j]local aj=ah-ag;for i=a2,a3 do local L=(i-a0)/ai;local Q=ag+L*aj;if Q>s[i]then s[i]=Q;r[i]=u end end end end;local U=U;if U or self.triangleEdges then local a4=self.drawLineInterp;local u=U or R;a4(self,C,D,E,F,u,N,O)a4(self,E,F,S,T,u,O,a9)a4(self,S,T,C,D,u,a9,N)end end;function m:drawBuffer()if term.getGraphicsMode()~=1 then term.setGraphicsMode(1)end;term.setFrozen(true)local am=self.blitWin;b.drawBuffer(self.colorValues,am)term.setFrozen(false)end;function m:depthInterpolation(an)self.drawTriangle=an and self.drawTriangleInterp or self.drawTriangleNoInterp;self:clear()end;function m:useTriangleEdges(an)self.triangleEdges=an end;m:depthInterpolation(true)return m end;local function ao(ap,aq,ar,as,at)local au=at[1]local av=at[2]local aw=at[3]local ax=aq and aq-au or 0;local ay=ar and ar-av or 0;local az=as and as-aw or 0;for aA=1,#ap do local aB=ap[aA]local aC=ax+(aB[1]+aB[4]+aB[7])/3;local aD=ay+(aB[2]+aB[5]+aB[8])/3;local aE=az+(aB[3]+aB[6]+aB[9])/3;aB[16]=aC*aC+aD*aD+aE*aE end end;local aF=math.rad;local aG=math.sin;local aH=math.cos;local function aI(i,j,aJ,aK,aL)local a7=aL*aJ-aK*j;local j=aK*aJ+aL*j;local aJ=a7;return i,j,aJ end;local function aM(i,j,aJ,aK,aL)local a7=aL*aJ-aK*i;local i=aK*aJ+aL*i;local aJ=a7;return i,j,aJ end;local function aN(i,j,aJ,aK,aL)local F=aL*j-aK*i;local i=aK*j+aL*i;local j=F;return i,j end;local function aO(aP,aQ,aR,aS)local aT,aU=0,1;local aV,aW=0,1;local aX,aY=0,1;if aQ==0 then aQ=nil end;if aQ then aT,aU=aG(aQ),aH(aQ)end;if aR==0 then aR=nil end;if aR then aV,aW=aG(aR),aH(aR)end;if aS==0 then aS=nil end;if aS then aX,aY=aG(aS),aH(aS)end;local aZ={}for a_,aB in pairs(aP)do local C,D,a6=aB[1],aB[2],aB[3]local E,F,a7=aB[4],aB[5],aB[6]local S,T,a8=aB[7],aB[8],aB[9]if aR then C,D,a6=aM(C,D,a6,aV,aW)E,F,a7=aM(E,F,a7,aV,aW)S,T,a8=aM(S,T,a8,aV,aW)end;if aS then C,D=aN(C,D,a6,aX,aY)E,F=aN(E,F,a7,aX,aY)S,T=aN(S,T,a8,aX,aY)end;if aQ then C,D,a6=aI(C,D,a6,aT,aU)E,F,a7=aI(E,F,a7,aT,aU)S,T,a8=aI(S,T,a8,aT,aU)end;aZ[#aZ+1]={C,D,a6,E,F,a7,S,T,a8}aZ[#aZ][10]=aB[10]aZ[#aZ][11]=aB[11]aZ[#aZ][12]=aB[12]end;return aZ end;local b0={}function b0.invertTriangles(aP)if not aP or type(aP)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for aA=1,#aP do local b1=aP[aA]aP[aA]={x1=b1.x1,y1=b1.y1,z1=b1.z1,x2=b1.x3,y2=b1.y3,z2=b1.z3,x3=b1.x2,y3=b1.y2,z3=b1.z2,c=b1.c,forceRender=b1.forceRender,outlineColor=b1.outlineColor}end;return aP end;function b0.setOutline(aP,b2)if not aP or type(aP)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for aA=1,#aP do local b1=aP[aA]if type(b2)=="table"then b1.outlineColor=b2[b1.c]or b1.outlineColor else b1.outlineColor=b2 end end;return aP end;function b0.mapColor(aP,b2)if not aP or type(aP)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for aA=1,#aP do local b1=aP[aA]if type(b2)=="table"then b1.c=b2[b1.c]or b1.c else b1.c=b2 end end;return aP end;function b0.center(aP)local b3,b4=math.huge,-math.huge;local W,Y=math.huge,-math.huge;local b5,b6=math.huge,-math.huge;for aA=1,#aP do local b7=aP[aA]b3,b4=d(b3,b7.x1),e(b4,b7.x1)b3,b4=d(b3,b7.x2),e(b4,b7.x2)b3,b4=d(b3,b7.x3),e(b4,b7.x3)W,Y=d(W,b7.y1),e(Y,b7.y1)W,Y=d(W,b7.y2),e(Y,b7.y2)W,Y=d(W,b7.y3),e(Y,b7.y3)b5,b6=d(b5,b7.z1),e(b6,b7.z1)b5,b6=d(b5,b7.z2),e(b6,b7.z2)b5,b6=d(b5,b7.z3),e(b6,b7.z3)end;local b8=-(b4+b3)*0.5;local b9=-(Y+W)*0.5;local ba=-(b6+b5)*0.5;for aA=1,#aP do local b7=aP[aA]b7.x1=b7.x1+b8;b7.x2=b7.x2+b8;b7.x3=b7.x3+b8;b7.y1=b7.y1+b9;b7.y2=b7.y2+b9;b7.y3=b7.y3+b9;b7.z1=b7.z1+ba;b7.z2=b7.z2+ba;b7.z3=b7.z3+ba end;return aP,b8,b9,ba end;function b0.normalizeScale(aP)local bb=-math.huge;for aA=1,#aP do local b7=aP[aA]bb=e(bb,b7.x1)bb=e(bb,b7.x2)bb=e(bb,b7.x3)bb=e(bb,b7.y1)bb=e(bb,b7.y2)bb=e(bb,b7.y3)bb=e(bb,b7.z1)bb=e(bb,b7.z2)bb=e(bb,b7.z3)end;for aA=1,#aP do local b7=aP[aA]b7.x1=b7.x1/bb;b7.x2=b7.x2/bb;b7.x3=b7.x3/bb;b7.y1=b7.y1/bb;b7.y2=b7.y2/bb;b7.y3=b7.y3/bb;b7.z1=b7.z1/bb;b7.z2=b7.z2/bb;b7.z3=b7.z3/bb end;return aP end;function b0.normalizeScaleY(aP)local bb=-math.huge;for aA=1,#aP do local b7=aP[aA]bb=e(bb,b7.y1)bb=e(bb,b7.y2)bb=e(bb,b7.y3)end;for aA=1,#aP do local b7=aP[aA]b7.x1=b7.x1/bb;b7.x2=b7.x2/bb;b7.x3=b7.x3/bb;b7.y1=b7.y1/bb;b7.y2=b7.y2/bb;b7.y3=b7.y3/bb;b7.z1=b7.z1/bb;b7.z2=b7.z2/bb;b7.z3=b7.z3/bb end;return aP end;function b0.scale(aP,bc)for aA=1,#aP do local b7=aP[aA]b7.x1=b7.x1*bc;b7.x2=b7.x2*bc;b7.x3=b7.x3*bc;b7.y1=b7.y1*bc;b7.y2=b7.y2*bc;b7.y3=b7.y3*bc;b7.z1=b7.z1*bc;b7.z2=b7.z2*bc;b7.z3=b7.z3*bc end;return aP end;function b0.translate(aP,J,K,bd)for aA=1,#aP do local b7=aP[aA]b7.x1=b7.x1+(J or 0)b7.x2=b7.x2+(J or 0)b7.x3=b7.x3+(J or 0)b7.y1=b7.y1+(K or 0)b7.y2=b7.y2+(K or 0)b7.y3=b7.y3+(K or 0)b7.z1=b7.z1+(bd or 0)b7.z2=b7.z2+(bd or 0)b7.z3=b7.z3+(bd or 0)end;return aP end;function b0.rotate(aP,aQ,aR,aS)local aT,aU=0,1;local aV,aW=0,1;local aX,aY=0,1;if aQ==0 then aQ=nil end;if aQ then aT,aU=aG(aQ),aH(aQ)end;if aR==0 then aR=nil end;if aR then aV,aW=aG(aR),aH(aR)end;if aS==0 then aS=nil end;if aS then aX,aY=aG(aS),aH(aS)end;for aA=1,#aP do local aB=aP[aA]local C,D,a6=aB.x1,aB.y1,aB.z1;local E,F,a7=aB.x2,aB.y2,aB.z2;local S,T,a8=aB.x3,aB.y3,aB.z3;if aR then C,D,a6=aM(C,D,a6,aV,aW)E,F,a7=aM(E,F,a7,aV,aW)S,T,a8=aM(S,T,a8,aV,aW)end;if aS then C,D=aN(C,D,a6,aX,aY)E,F=aN(E,F,a7,aX,aY)S,T=aN(S,T,a8,aX,aY)end;if aQ then C,D,a6=aI(C,D,a6,aT,aU)E,F,a7=aI(E,F,a7,aT,aU)S,T,a8=aI(S,T,a8,aT,aU)end;aB.x1,aB.y1,aB.z1=C,D,a6;aB.x2,aB.y2,aB.z2=E,F,a7;aB.x3,aB.y3,aB.z3=S,T,a8 end;return aP end;function b0.alignBottom(aP)local W=math.huge;for aA=1,#aP do local b7=aP[aA]W=d(W,b7.y1)W=d(W,b7.y2)W=d(W,b7.y3)end;for aA=1,#aP do local b7=aP[aA]b7.y1=b7.y1-W;b7.y2=b7.y2-W;b7.y3=b7.y3-W end;return aP end;function b0.decimate(aP,be,bf)local bg={}local bh={}local function bi(i,j,aJ)for aA=#bg,1,-1 do local bj=bg[aA]if bj[1]==i and bj[2]==j and bj[3]==aJ then return aA end end end;for aA=1,#aP do local b7=aP[aA]local bk=bi(b7.x1,b7.y1,b7.z1)if not bk then bg[#bg+1]={b7.x1,b7.y1,b7.z1}bk=#bg end;local bl=bi(b7.x2,b7.y2,b7.z2)if not bl then bg[#bg+1]={b7.x2,b7.y2,b7.z2}bl=#bg end;local bm=bi(b7.x3,b7.y3,b7.z3)if not bm then bg[#bg+1]={b7.x3,b7.y3,b7.z3}bm=#bg end;local b1={bk,bl,bm,b7.c,b7.forceRender}bh[#bh+1]=b1 end;local function bn(bo,bp)local J=bo[1]-bp[1]local K=bo[2]-bp[2]local bd=bo[3]-bp[3]return(J*J+K*K+bd*bd)^0.5 end;local bq={}for aA=1,#bh do local b1=bh[aA]local br=bn(bg[b1[1]],bg[b1[2]])local bs=bn(bg[b1[2]],bg[b1[3]])local bt=bn(bg[b1[1]],bg[b1[3]])bq[#bq+1]={length=br,vA=b1[1],vB=b1[2]}bq[#bq+1]={length=bs,vA=b1[2],vB=b1[3]}bq[#bq+1]={length=bt,vA=b1[1],vB=b1[3]}end;local function bu(bv,bw)local bx=bg[bv]local by=bg[bw]local bz={(bx[1]+by[1])*0.5,(bx[2]+by[2])*0.5,(bx[3]+by[3])*0.5}bg[#bg+1]=bz;local bA=#bg;for aA=#bh,1,-1 do local bB=bh[aA]if bB[1]==bv or bB[1]==bw or bB[2]==bv or bB[2]==bw or bB[3]==bv or bB[3]==bw then if bB[1]==bv or bB[1]==bw then bB[1]=bA end;if bB[2]==bv or bB[2]==bw then bB[2]=bA end;if bB[3]==bv or bB[3]==bw then bB[3]=bA end;if bB[1]==bB[2]or bB[2]==bB[3]or bB[1]==bB[3]then table.remove(bh,aA)end end end;return bA end;local bC=be;if bf~="polys"then bC=#aP*be end;while#bh>bC do local bD=math.huge;local bE;for aA=1,#bq do local bF=bq[aA]if bF.length<bD then bD=bF.length;bE=aA end end;local bG=bq[bE]local bA=bu(bG.vA,bG.vB)for aA=#bq,1,-1 do local bF=bq[aA]local bH=bF.vA==bG.vA or bF.vA==bG.vB;local bI=bF.vB==bG.vA or bF.vB==bG.vB;if bH and bI then table.remove(bq,aA)elseif bH then bF.vA=bA elseif bI then bF.vB=bA end end end;local bJ={}for aA=1,#bh do local b1=bh[aA]local bo=bg[b1[1]]local bp=bg[b1[2]]local bK=bg[b1[3]]bJ[#bJ+1]={x1=bo[1],y1=bo[2],z1=bo[3],x2=bp[1],y2=bp[2],z2=bp[3],x3=bK[1],y3=bK[2],z3=bK[3],c=b1[4],forceRender=b1[5]}end;for bL,bM in pairs(b0)do bJ[bL]=bM end;return bJ end;local bN,bO;function b0.toLoD(aP,bP)bP=bP or{}local bQ={minQuality=bP.minQuality or 0.1,variantCount=bP.variantCount or 4,qualityHalvingDistance=bP.qualityHalvingDistance or 5,quickInitWorseRuntime=bP.quickInitWorseRuntime or false}local bR,bS=bO(aP)local bT={{quality=1,collapsedModel=bR,size=bS}}local bU=aP;local bV=#bU;for aA=1,bQ.variantCount do local be=(1-bQ.minQuality)*(1-aA/bQ.variantCount)+bQ.minQuality;local bW=math.floor(bV*be+0.5)local bX=bU:decimate(bW,"polys")local bR,bS=bO(bX)bU=bX;local bY={quality=be,collapsedModel=bR,size=bS}bT[#bT+1]=bY end;local function bZ(b_)local c0={}for aA=1,#b_ do local bY=b_[aA]local aP=bY.collapsedModel;local c1={}for c2=1,#aP do local b7=aP[c2]local c3={b7[1],b7[2],b7[3],b7[4],b7[5],b7[6],b7[7],b7[8],b7[9],b7[10],b7[11],b7[12]}c1[c2]=c3 end;local c4={quality=bY.quality,size=bY.size,collapsedModel=c1}c0[aA]=c4 end;return c0 end;local c5={}function bQ:initObject(c6)local c7;if bQ.quickInitWorseRuntime then c7=bT else c7=bZ(bT)end;c5[c6]=c7;c6[7]=c7[1].collapsedModel;c6[8]=c7[1].size;c6[9]=bQ end;function bQ:update(c6,at)local c7=c5[c6]if c7 then local J=at[1]-c6[1]local K=at[2]-c6[2]local bd=at[3]-c6[3]local a5=(J*J+K*K+bd*bd)^0.5;local c8=math.min(1,math.max(bQ.minQuality,1/(a5/bQ.qualityHalvingDistance)))local c9=bQ.variantCount+1-bQ.variantCount*(c8-bQ.minQuality)/(1-bQ.minQuality)local ca=math.floor(c9+0.5)local bY=c7[ca]c6[7]=bY.collapsedModel;c6[8]=bY.size end end;return bQ end;local cb=math.sqrt;function bO(aP)local cc={}local cd=0;for aA=1,#aP do local aB=aP[aA]cc[#cc+1]={}cc[#cc][1]=aB.x1;cc[#cc][2]=aB.y1;cc[#cc][3]=aB.z1;cc[#cc][4]=aB.x2;cc[#cc][5]=aB.y2;cc[#cc][6]=aB.z2;cc[#cc][7]=aB.x3;cc[#cc][8]=aB.y3;cc[#cc][9]=aB.z3;cc[#cc][10]=aB.forceRender;cc[#cc][11]=aB.c;cc[#cc][12]=aB.outlineColor;local ce=cb(aB.x1*aB.x1+aB.y1*aB.y1+aB.z1*aB.z1)local cf=cb(aB.x2*aB.x2+aB.y2*aB.y2+aB.z2*aB.z2)local cg=cb(aB.x3*aB.x3+aB.y3*aB.y3+aB.z3*aB.z3)if ce>cd then cd=ce end;if cf>cd then cd=cf end;if cg>cd then cd=cg end end;return cc,cd end;function bN(ch)local ci=fs.open(ch,"r")if not ci then error("Could not find model for an object at path: "..ch)end;local cj=ci.readAll()ci.close()if not cj then error("Failed to parse model for an object at path: "..ch)end;local aP=textutils.unserialise(cj)for bL,bM in pairs(b0)do aP[bL]=bM end;return aP end;local ck=math.pi;local aG=math.sin;local aH=math.cos;local cl=math.tan;local cb=math.sqrt;local function cm(i,j,k,l)local cn,co=term.getSize(1)i=i or 1;j=j or 1;k=k or cn;l=l or co;local cp={camera={0,0,0,nil,0,0},buffer=h(i,j,k,l),width=k,height=l}cp.FoV=90;cp.camera[7]=aF(cp.FoV)cp.camera[8]=2*math.atan(math.tan(aF(cp.FoV)*0.5)/(cp.width/cp.height/1.5))cp.t=cl(aF(cp.FoV/2))*2*0.0001;local cq,cr,cs,ct;function cp:setBackgroundColor(u)local cu=self.buffer;cu.backgroundColor=u;cu:fastClear()end;local function cv()cq=f(cp.width*0.5)+1;cr=f(cp.height*0.5)cs=0.0001*cp.width/cp.t;ct=-0.0001*cp.width/(cp.t*cp.height)*cp.height end;cv()function cp:setSize(i,j,k,l)self.width=k;self.height=l;self.buffer:setSize(i,j,k,l)cv()end;function cp:depthInterpolation(an)self.interpolateDepth=an;self.buffer:depthInterpolation(an)end;function cp:map3dTo2d(i,j,aJ)local at=self.camera;local cw=aG(at[4]or 0)local cx=aH(at[4]or 0)local cy=aG(-at[5])local cz=aH(-at[5])local cA=aG(at[6])local cB=aH(at[6])local cC=i-at[1]local cD=j-at[2]local cE=aJ-at[3]local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;if cw~=0 then local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH end;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC>=0.0001 end;function cp:drawObject(c6,at,cK)local cL=c6[1]local cM=c6[2]local cN=c6[3]local cw=cK[1]local cx=cK[2]local cy=cK[3]local cz=cK[4]local cA=cK[5]local cB=cK[6]local cO=cL and cL-at[1]or 0;local cP=cM and cM-at[2]or 0;local cQ=cN and cN-at[3]or 0;local bQ=c6[9]if bQ then bQ:update(c6,at)end;local aP=c6[7]if#aP<=0 then return end;local bS=c6[8]local cC=cO;local cD=cP;local cE=cQ;local cF=cz*cC-cy*cE;local cE=cy*cC+cz*cE;local cC=cF;local cG=cB*cD-cA*cC;local cC=cA*cD+cB*cC;cD=cG;if cC<-bS then return true end;local cR=0.5*at[7]local cS=aG(cR)local cT=aH(cR)if(cC+bS)*cS+(cE+bS)*cT<0 then return true end;if(cC+bS)*cS-(cE-bS)*cT<0 then return true end;local cU=0.5*at[8]local cS=aG(cU)local cV=aH(cU)if(cC+bS)*cS+(cD+bS)*cV<0 then return true end;if(cC+bS)*cS-(cD-bS)*cV<0 then return true end;local aQ=c6[4]local aR=c6[5]local aS=c6[6]if aQ and aQ~=0 or aR and aR~=0 or aS and aS~=0 then aP=aO(aP,aQ,aR,aS)end;ao(aP,cL,cM,cN,at)local cW=cO*cO+cP*cP+cQ*cQ<bS*bS*4;local cq=cq;local cr=cr;local cs=cs;local ct=ct;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cA=cA;local cB=cB;local cO=cO;local cP=cP;local cQ=cQ;local function cX(cC,cD,cE)local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC end;if cw~=0 then function cX(cC,cD,cE)local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC end end;local cY=aP;local cu=self.buffer;for aA=1,#cY do local aB=cY[aA]local V=aB[16]local C,D,cZ=cX(aB[1]+cO,aB[2]+cP,aB[3]+cQ)if cZ>0.00010000001 then local E,F,cF=cX(aB[4]+cO,aB[5]+cP,aB[6]+cQ)if cF>0.00010000001 then local S,T,c_=cX(aB[7]+cO,aB[8]+cP,aB[9]+cQ)if c_>0.00010000001 then if aB[10]or(E-C)*(T-F)-(F-D)*(S-E)<0 then cu:drawTriangle(C,D,E,F,S,T,aB[11],aB[12],V,cZ,cF,c_)end elseif cW then local function d0(i,j,aJ)local cC=i+cO;local cD=j+cP;local cE=aJ+cQ;local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;if cw~=0 then local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH end;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC,cD,cE end;local C,D,cZ,d1,d2=d0(aB[1],aB[2],aB[3])local E,F,cF,cG,cH=d0(aB[4],aB[5],aB[6])local S,T,c_,d3,d4=d0(aB[7],aB[8],aB[9])local d5=math.abs;local d6=d5(c_-0.0001)local d7=d5(cZ-0.0001)local d8=d7+d6;local d9=(d4*d7+d2*d6)/d8;local da=(d3*d7+d1*d6)/d8;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;if aB[10]or(E-C)*(dc-F)-(F-D)*(db-E)<0 then cu:drawTriangle(C,D,E,F,db,dc,aB[11],aB[12],V,cZ,cF,0.0001)local dd=d5(cF-0.0001)local d8=dd+d6;local d9=(cH*d6+d4*dd)/d8;local da=(cG*d6+d3*dd)/d8;local de=d9*10000*cs+cq;local df=da*10000*ct+cr;cu:drawTriangle(de,df,E,F,db,dc,aB[11],aB[12],V,0.0001,cF,0.0001)end end elseif cW then local function d0(i,j,aJ)local cC=i+cO;local cD=j+cP;local cE=aJ+cQ;local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;if cw~=0 then local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH end;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC,cD,cE end;local C,D,cZ,d1,d2=d0(aB[1],aB[2],aB[3])local E,F,cF,cG,cH=d0(aB[4],aB[5],aB[6])local S,T,c_,d3,d4=d0(aB[7],aB[8],aB[9])local d5=math.abs;if c_>0.00010000001 then local dd=d5(cF-0.0001)local d7=d5(cZ-0.0001)local d8=d7+dd;local d9=(cH*d7+d2*dd)/d8;local da=(cG*d7+d1*dd)/d8;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;if aB[10]or(db-C)*(T-dc)-(dc-D)*(S-db)<0 then cu:drawTriangle(C,D,db,dc,S,T,aB[11],aB[12],V,cZ,0.0001,c_)local d6=d5(c_-0.0001)local d8=dd+d6;local d9=(cH*d6+d4*dd)/d8;local da=(cG*d6+d3*dd)/d8;local de=d9*10000*cs+cq;local df=da*10000*ct+cr;cu:drawTriangle(de,df,db,dc,S,T,aB[11],aB[12],V,0.0001,0.0001,c_)end else local d7=d5(cZ-0.0001)local dd=d5(cF-0.0001)local d6=d5(c_-0.0001)local dg=d7+dd;local dh=d7+d6;local d9=(d2*dd+cH*d7)/dg;local da=(d1*dd+cG*d7)/dg;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;local di=(d2*d6+d4*d7)/dh;local dj=(d1*d6+d3*d7)/dh;local de=di*10000*cs+cq;local df=dj*10000*ct+cr;if aB[10]or(db-C)*(df-dc)-(dc-D)*(de-db)<0 then cu:drawTriangle(C,D,db,dc,de,df,aB[11],aB[12],V,cZ,0.0001,0.0001)end end end elseif cW then local function d0(i,j,aJ)local cC=i+cO;local cD=j+cP;local cE=aJ+cQ;local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;if cw~=0 then local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH end;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC,cD,cE end;local C,D,cZ,d1,d2=d0(aB[1],aB[2],aB[3])local E,F,cF,cG,cH=d0(aB[4],aB[5],aB[6])local S,T,c_,d3,d4=d0(aB[7],aB[8],aB[9])local d5=math.abs;if cF>0.00010000001 then if c_>0.00010000001 then local d7=d5(cZ-0.0001)local dd=d5(cF-0.0001)local d8=d7+dd;local d9=(d2*dd+cH*d7)/d8;local da=(d1*dd+cG*d7)/d8;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;if aB[10]or(E-db)*(T-F)-(F-dc)*(S-E)<0 then cu:drawTriangle(db,dc,E,F,S,T,aB[11],aB[12],V,0.0001,cF,c_)local d6=d5(c_-0.0001)local d8=d7+d6;local d9=(d2*d6+d4*d7)/d8;local da=(d1*d6+d3*d7)/d8;local de=d9*10000*cs+cq;local df=da*10000*ct+cr;cu:drawTriangle(db,dc,de,df,S,T,aB[11],aB[12],V,0.0001,0.0001,c_)end else local d7=d5(cZ-0.0001)local dd=d5(cF-0.0001)local d6=d5(c_-0.0001)local dg=dd+d7;local dh=dd+d6;local d9=(d2*dd+cH*d7)/dg;local da=(d1*dd+cG*d7)/dg;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;local di=(cH*d6+d4*dd)/dh;local dj=(cG*d6+d3*dd)/dh;local de=di*10000*cs+cq;local df=dj*10000*ct+cr;if aB[10]or(E-db)*(df-F)-(F-dc)*(de-E)<0 then cu:drawTriangle(db,dc,E,F,de,df,aB[11],aB[12],V,0.0001,cF,0.0001)end end else if c_>0.00010000001 then local d7=d5(cZ-0.0001)local dd=d5(cF-0.0001)local d6=d5(c_-0.0001)local dg=d6+d7;local dh=d6+dd;local d9=(d2*d6+d4*d7)/dg;local da=(d1*d6+d3*d7)/dg;local cq,cs,cr,ct=cq,cs,cr,ct;local db=d9*10000*cs+cq;local dc=da*10000*ct+cr;local di=(cH*d6+d4*dd)/dh;local dj=(cG*d6+d3*dd)/dh;local de=di*10000*cs+cq;local df=dj*10000*ct+cr;if aB[10]or(de-db)*(T-df)-(df-dc)*(S-de)<0 then cu:drawTriangle(db,dc,de,df,S,T,aB[11],aB[12],V,0.0001,0.0001,c_)end end end end end end;function cp:drawObjects(dk)self.buffer:clearDepth()local at=self.camera;local cK={aG(at[4]or 0),aH(at[4]or 0),aG(-at[5]),aH(-at[5]),aG(at[6]),aH(at[6])}local dk=dk;for aA=1,#dk do self:drawObject(dk[aA],at,cK)end end;function cp:drawBuffer()local cu=self.buffer;cu:drawBuffer()cu:fastClear()end;function cp:setCamera(dl,dm,dn,aQ,aR,aS)local aF=math.rad;if type(dl)=="table"then local at=dl;self.camera={at.x or self.camera[1]or 0,at.y or self.camera[2]or 0,at.z or self.camera[3]or 0,at.rotX and aF(at.rotX+90)or self.camera[4]or 0,at.rotY and aF(at.rotY)or self.camera[5]or 0,at.rotZ and aF(at.rotZ)or self.camera[6]or 0,self.camera[7],self.camera[8]}else self.camera={dl or self.camera[1]or 0,dm or self.camera[2]or 0,dn or self.camera[3]or 0,aQ and aF(aQ+90)or self.camera[4]or 0,aR and aF(aR)or self.camera[5]or 0,aS and aF(aS)or self.camera[6]or 0,self.camera[7],self.camera[8]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function cp:setFoV(cR)self.FoV=cR or 90;self.t=cl(aF(self.FoV/2))*2*0.0001;cv()self.camera[7]=aF(self.FoV)self.camera[8]=2*math.atan(math.tan(aF(self.FoV)*0.5)/(self.width/self.height/1.5))end;function cp:setWireFrame(an)self.buffer:useTriangleEdges(an)end;function cp:getObjectIndexTrace(dk,i,j)local function dp(C,D,E,F,S,T)return(C-S)*(F-T)-(E-S)*(D-T)end;local function dq(dr,ds,C,D,E,F,S,T,dt,du,dv,dw)local dx=dp(dr,ds,C,D,E,F)<0;local dy=dp(dr,ds,E,F,S,T)<0;local dz=dp(dr,ds,S,T,C,D)<0;return dx==dy and dy==dz end;local j=j-1;local dA=self.x1;local dB=self.y1;local dC=self.x2;local dD=self.y2;i=i;j=j+1;local at=self.camera;local cK={aG(at[4]or 0),aH(at[4]or 0),aG(-at[5]),aH(-at[5]),aG(at[6]),aH(at[6])}local cw=cK[1]local cx=cK[2]local cy=cK[3]local cz=cK[4]local cA=cK[5]local cB=cK[6]local dE={}for aA=1,#dk do local c6=dk[aA]local aP=c6[7]local aQ=c6[4]local aR=c6[5]local aS=c6[6]if aQ and aQ~=0 or aR and aR~=0 or aS and aS~=0 then aP=aO(aP,aQ,aR,aS)end;local cL=c6[1]local cM=c6[2]local cN=c6[3]ao(aP,cL,cM,cN,at)local cq=cq;local cr=cr;local cs=cs;local ct=ct;local cw=cw;local cx=cx;local cy=cy;local cz=cz;local cA=cA;local cB=cB;local cO=cL-at[1]local cP=cM-at[2]local cQ=cN-at[3]local function cX(i,j,aJ)local cC=i+cO;local cD=j+cP;local cE=aJ+cQ;local cF=cz*cC-cy*cE;cE=cy*cC+cz*cE;cC=cF;local cG=cB*cD-cA*cC;cC=cA*cD+cB*cC;cD=cG;if cw~=0 then local cH=cw*cE-cx*cD;cD=cx*cE+cw*cD;cE=cH end;local cI=cE/cC*cs+cq;local cJ=cD/cC*ct+cr;return cI,cJ,cC>0 end;for c2=1,#aP do local aB=aP[c2]local C,D,dF=cX(aB[1],aB[2],aB[3])if dF then local E,F,dG=cX(aB[4],aB[5],aB[6])if dG then local S,T,dH=cX(aB[7],aB[8],aB[9])if dH then if aB[10]or(E-C)*(T-F)-(F-D)*(S-E)<0 then local aC=cO+(aB[1]+aB[4]+aB[7])/3;local aD=cP+(aB[2]+aB[5]+aB[8])/3;local aE=cQ+(aB[3]+aB[6]+aB[9])/3;local V=aC*aC+aD*aD+aE*aE;if dq(i,j,C,D,E,F,S,T,(dC-1)*2+1,(dB-1)*3+1,dC*2,(dD+1)*3)then dE[#dE+1]={objectIndex=aA,polygonIndex=c2,depth=V}end end end end end end end;if#dE<=0 then return elseif#dE==1 then return dE[1].objectIndex,dE[1].polygonIndex,dE[1].depth end;local dI=-1;local dJ=math.huge;for aA=1,#dE do local dK=dE[aA]if dK.depth<dJ then dJ=dK.depth;dI=aA end end;local dK=dE[dI]return dK.objectIndex,dK.polygonIndex,dK.depth end;function cp:newObject(aP,i,j,aJ,aQ,aR,aS)local bR=nil;local bS=nil;if type(aP)=="table"then if aP.initObject then else bR,bS=bO(aP)end else local dL=bN(aP)bR,bS=bO(dL)end;local c6={i,j,aJ,aQ,aR,aS,bR,bS}c6.frame=self;function c6:setPos(dM,dN,dO)self[1]=dM or self[1]self[2]=dN or self[2]self[3]=dO or self[3]end;function c6:setRot(dP,dQ,dR)self[4]=dP or self[4]self[5]=dQ or self[5]self[6]=dR or self[6]end;function c6:setModel(dS)if type(dS)=="table"then bR,bS=bO(dS)self[7]=bR;self[8]=bS else local dL=bN(dS)bR,bS=bO(dL)self[7]=bR;self[8]=bS end end;if type(aP)=="table"then if aP.initObject then aP:initObject(c6)end end;return c6 end;function cp:newCompressedObject(aP,i,j,aJ,aQ,aR,aS)local bR=nil;local bS=nil;if type(aP)=="table"then if aP.initObject then else local dT=c.unpack_model(aP)bR,bS=bO(dT)end else local dT=c.unpack_file(aP)bR,bS=bO(dT)end;local c6={i,j,aJ,aQ,aR,aS,bR,bS}c6.frame=self;function c6:setPos(dM,dN,dO)self[1]=dM or self[1]self[2]=dN or self[2]self[3]=dO or self[3]end;function c6:setRot(dP,dQ,dR)self[4]=dP or self[4]self[5]=dQ or self[5]self[6]=dR or self[6]end;function c6:setModel(dS)if type(dS)=="table"then bR,bS=bO(dS)self[7]=bR;self[8]=bS else local dL=bN(dS)bR,bS=bO(dL)self[7]=bR;self[8]=bS end end;if type(aP)=="table"then if aP.initObject then aP:initObject(c6)end end;return c6 end;cp:depthInterpolation(true)return cp end;local dU={}local function dV(C,D,a6,E,F,a7,S,T,a8,u)local b7={x1=C,y1=D,z1=a6,x2=E,y2=F,z2=a7,x3=S,y3=T,z3=a8,c=u}return b7 end;function dU:cube(dW)dW.color=dW.color or colors.red;local dX={dV(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,dW.bottom or dW.color),dV(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,dW.bottom2 or dW.bottom or dW.color),dV(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,dW.top or dW.color),dV(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,dW.top or dW.color),dV(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,dW.side or dW.color),dV(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,dW.side2 or dW.side or dW.color),dV(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,dW.side or dW.color),dV(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,dW.side2 or dW.side or dW.color),dV(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,dW.side or dW.color),dV(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,dW.side2 or dW.side or dW.color),dV(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,dW.side or dW.color),dV(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,dW.side2 or dW.side or dW.color)}for bL,bM in pairs(b0)do dX[bL]=bM end;return dX end;function dU:sphere(dW)dW.res=dW.res or 32;dW.color=dW.color or colors.red;local aP={}local dY={}for aA=0,dW.res do local j=0.5*aH(aA/dW.res*ck)local dZ={}for c2=0,dW.res do local d_=0.5*cb(1-j*2*j*2)local i=aH(c2/dW.res*ck*2)*d_;local aJ=aG(c2/dW.res*ck*2)*d_;local E=aH((c2+1)/dW.res*ck*2)*d_;local a7=aG((c2+1)/dW.res*ck*2)*d_;if dY[c2]then aP[#aP+1]={x1=dY[(c2+1)%dW.res].x,y1=dY[(c2+1)%dW.res].y,z1=dY[(c2+1)%dW.res].z,x2=i,y2=j,z2=aJ,x3=dY[c2].x,y3=dY[c2].y,z3=dY[c2].z,c=dW.color}aP[#aP+1]={x1=E,y1=j,z1=a7,x2=i,y2=j,z2=aJ,x3=dY[(c2+1)%dW.res].x,y3=dY[(c2+1)%dW.res].y,z3=dY[(c2+1)%dW.res].z,c=dW.color2 or dW.color}end;dZ[c2]={x=i,y=j,z=aJ}end;dY=dZ end;if dW.colors or dW.top or dW.bottom then for aA=1,#aP do local b7=aP[aA]local aD=(b7.y1+b7.y2+b7.y3)/3;if dW.colors then local e0=f((-aD+0.5)*#dW.colors+1)b7.c=dW.colors[e0]or b7.c else if aD>=0 then b7.c=dW.top or b7.c else b7.c=dW.bottom or b7.c end end end end;for bL,bM in pairs(b0)do aP[bL]=bM end;return aP end;function dU:icosphere(dW)dW.res=dW.res or 1;local e1=(1+cb(5))/2;local e2={{e1,1,0},{e1,-1,0},{-e1,-1,0},{-e1,1,0},{1,0,e1},{-1,0,e1},{-1,0,-e1},{1,0,-e1},{0,e1,1},{0,e1,-1},{0,-e1,-1},{0,-e1,1}}local function e3(bk,bl,bm)return dV(e2[bk][1],e2[bk][2],e2[bk][3],e2[bl][1],e2[bl][2],e2[bl][3],e2[bm][1],e2[bm][2],e2[bm][3],dW.colors and 1 or dW.color)end;local aP={e3(11,2,12),e3(11,8,2),e3(11,7,8),e3(11,3,7),e3(11,12,3),e3(4,7,3),e3(4,10,7),e3(4,9,10),e3(4,6,9),e3(4,3,6),e3(5,6,12),e3(5,9,6),e3(5,1,9),e3(5,2,1),e3(5,12,2),e3(3,12,6),e3(1,8,10),e3(1,10,9),e3(1,2,8),e3(10,8,7)}local function e4()local bJ={}for aA=1,#aP do local b7=aP[aA]local e5={x=(b7.x1+b7.x2)/2,y=(b7.y1+b7.y2)/2,z=(b7.z1+b7.z2)/2}local e6={x=(b7.x1+b7.x3)/2,y=(b7.y1+b7.y3)/2,z=(b7.z1+b7.z3)/2}local e7={x=(b7.x2+b7.x3)/2,y=(b7.y2+b7.y3)/2,z=(b7.z2+b7.z3)/2}local e8=b7.c;if dW.colorsFractal then e8=e8%#dW.colors+1 end;bJ[#bJ+1]=dV(e5.x,e5.y,e5.z,e7.x,e7.y,e7.z,e6.x,e6.y,e6.z,b7.c)bJ[#bJ+1]=dV(b7.x1,b7.y1,b7.z1,e5.x,e5.y,e5.z,e6.x,e6.y,e6.z,e8)bJ[#bJ+1]=dV(e5.x,e5.y,e5.z,b7.x2,b7.y2,b7.z2,e7.x,e7.y,e7.z,e8)bJ[#bJ+1]=dV(e6.x,e6.y,e6.z,e7.x,e7.y,e7.z,b7.x3,b7.y3,b7.z3,e8)end;aP=bJ end;for aA=1,dW.res-1 do e4()end;local function e9(i,j,aJ)local ea=math.sqrt(i*i+j*j+aJ*aJ)local eb=0.5/ea;return i*eb,j*eb,aJ*eb end;for aA=1,#aP do local b7=aP[aA]b7.x1,b7.y1,b7.z1=e9(b7.x1,b7.y1,b7.z1)b7.x2,b7.y2,b7.z2=e9(b7.x2,b7.y2,b7.z2)b7.x3,b7.y3,b7.z3=e9(b7.x3,b7.y3,b7.z3)if not dW.colorsFractal then local aD=(b7.y1+b7.y2+b7.y3)/3;if dW.colors then local e0=math.floor((-aD+0.5)*#dW.colors+1)b7.c=dW.colors[e0]or b7.c else if aD>=0 then b7.c=dW.top or b7.c else b7.c=dW.bottom or b7.c end end else b7.c=dW.colors[b7.c]end end;for bL,bM in pairs(b0)do aP[bL]=bM end;return aP end;function dU:plane(dW)dW.color=dW.color or colors.lime;dW.size=dW.size or 1;dW.y=dW.y or 0;local ec={dV(-1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,-1*dW.size,-1*dW.size,dW.y,-1*dW.size,dW.color),dV(-1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,1*dW.size,1*dW.size,dW.y,-1*dW.size,dW.color)}for bL,bM in pairs(b0)do ec[bL]=bM end;return ec end;function dU:mountains(dW)dW.res=dW.res or 20;dW.randomOffset=dW.randomOffset or 0;dW.height=dW.height or 1;dW.randomHeight=dW.randomHeight or 0;dW.y=dW.y or 0;dW.scale=dW.scale or 100;dW.color=dW.color or colors.green;dW.snowColor=dW.snowColor or colors.white;local ed=3/dW.res*dW.height/(dW.randomHeight+1)local ee=3/dW.res*dW.height*(dW.randomHeight+1)local aP={}for aA=0,dW.res do local ef=math.random(-dW.randomOffset*100,dW.randomOffset*100)/100;local eg=aA+ef;local C=aH((eg-1)/dW.res*ck*2)*dW.scale;local a6=aG((eg-1)/dW.res*ck*2)*dW.scale;local E=aH((eg-0.5)/dW.res*ck*2)*dW.scale;local a7=aG((eg-0.5)/dW.res*ck*2)*dW.scale;local S=aH(eg/dW.res*ck*2)*dW.scale;local a8=aG(eg/dW.res*ck*2)*dW.scale;local eh=math.random(ed*100,ee*100)/100*dW.scale;local aB={x1=C,y1=dW.y,z1=a6,x2=S,y2=dW.y,z2=a8,x3=E,y3=dW.y+eh,z3=a7,c=dW.color,forceRender=true}aP[#aP+1]=aB;if dW.snow then local ei=0.93;local ej=dW.snowHeight or 0.5;local ek=1-ej*ee/(eh/dW.scale)ek=e(0,d(1,ek))if ek>0.2 then local el={x1=(C*ek+E*(1-ek))*ei,y1=dW.y+eh*(1-ek),z1=(a6*ek+a7*(1-ek))*ei,x2=(S*ek+E*(1-ek))*ei,y2=dW.y+eh*(1-ek),z2=(a8*ek+a7*(1-ek))*ei,x3=E*ei,y3=dW.y+eh,z3=a7*ei,c=dW.snowColor,forceRender=true}aP[#aP+1]=el end end end;for bL,bM in pairs(b0)do aP[bL]=bM end;return aP end;return{newFrame=cm,loadModel=bN,newBuffer=h,models=dU,transforms=b0}
